# MEGAGAME 2026: Mega Man X Browser Game

## Context

A Mega Man X-style action platformer built with plain HTML5 Canvas and JavaScript. All sprite and stage assets sourced from [MMX-Online-Deathmatch](https://github.com/gamemaker19/MMX-Online-Deathmatch), an open-source fan game with complete, high-quality PNG spritesheets and JSON animation data. Originally started as a SNES ROM port (Plan 1.0, abandoned due to CX4 coprocessor complexity).

**Goal:** A playable browser game with authentic MMX gameplay — not an emulator wrapper.

---

## Plan 1.0 — ROM-Based Sprite Extraction (ABANDONED)

### Summary

Our original approach was to extract all sprite graphics directly from the SNES ROM data, decoding tiles, palettes, and animation frames from raw ROM bytes. This involved:

1. **ROM Parsing Pipeline** — Built hex parser, LoROM mapper, 4bpp tile decoder, and SNES palette decoder. All working correctly — tiles and palettes decode fine.

2. **CX4 Coprocessor Reverse Engineering** — Disassembled the CX4 DMA sprite routine at `$08:CA5C`, decoded the DMA transfer table at `$05:$9609` (112 entries, 6-byte format), and mapped out the full animation system (11 animations, 19 sprite defs, 3-byte frame entries at `$2F:D4D6`).

3. **OAM Layout Discovery** — Decoded the CX4 sub-sprite system at `$0D:$B01E` (variable-count defs per frame, up to 31 sub-sprites), and confirmed a 4-block OAM layout: head, upper-body-left, upper-body-right, and legs.

4. **DMA Tile Remapping** — Each of the 19 sprite defs remaps VRAM tiles 0-31 to different positions in the ROM tilesheet at `0x168000`. Wrote `sprite-frames.js` with per-def tile remap tables.

### Why It Failed

**The CX4 coprocessor made this approach impractical.** The Capcom CX4 (Hitachi HG51B169 DSP) is a custom coprocessor that handles player sprite assembly at runtime. Key problems:

- **Runtime code injection**: The CX4 uploads wrapper routines to WRAM at `$7E:2680-$7E:2692` during initialization. These routines are NOT in the cartridge ROM — they're generated by the CX4 chip itself. Without emulating the CX4, we cannot reproduce these routines.

- **Complex multi-layer sprite assembly**: The CX4's Build OAM function (`op00_00`) assembles up to 31 sub-sprites per frame, including 8-9 body blocks plus 22-23 detail/effect overlays (8x8 sprites for outline details, helmet gem, buster glow, etc.). Our simplified 4-block layout captured the basic shape but missed all the detail sprites that make the character look correct.

- **Missing leg tile source**: Leg tiles (VRAM positions 64, 65, 80, 81) are loaded by a separate init mechanism not part of the main DMA table. Tiles 64-65 were found at ROM `$2F:$8D40`, but tiles 80-81 appear to be CX4-generated at runtime. We had to resort to savestate extraction as a fallback.

- **Palette runtime modification**: ROM palette 14 is correct structurally, but the game modifies palettes at runtime for charge effects, damage flashing, etc. The savestate showed palette 14 as all-zeros at the expected CGRAM position.

- **Net result**: After weeks of reverse engineering, the rendered sprites were recognizable but visually broken — wrong colors, missing detail tiles, garbled leg tiles. The CX4 does too much runtime processing to replicate from static ROM analysis alone.

### What Was Preserved

The ROM parsing pipeline was fully removed in Plan 2.1. All `src/rom/` files, `sprite-frames.js`, and `asset-map.json` have been deleted. Background rendering now uses pre-rendered PNG images from MMX-Online-Deathmatch stage assets.

All reverse engineering findings are preserved below in the **Appendix** for reference.

---

## Plan 2.0 — MMX Deathmatch Sprite Source (CURRENT)

### New Approach

We discovered [MMX-Online-Deathmatch](https://github.com/gamemaker19/MMX-Online-Deathmatch), an open-source Mega Man X fan game with complete, high-quality sprite assets. The project contains:

- **Pre-made PNG spritesheets** with all character animations laid out cleanly
- **JSON animation definitions** with precise frame rects, durations, offsets, and POI (point of interest) data for projectile spawn positions
- **Multiple character spritesheets** (X, Zero, Vile, Sigma, Axl, 26+ Mavericks)
- **Effects spritesheets** for projectiles, explosions, and other VFX

All needed assets are copied into our `assets/` folder — nothing references the `MMX-Online-Deathmatch/` directory at runtime.

### Current Status

**Player Character (X):**
- Spritesheet: `assets/XDefault.png`, 19 animations in `sprite-data.js`
- 10-state machine: warp_in, idle, run, jump, fall, land, wall_slide, dash, hurt, die
- Warp-in animation on spawn (input locked), land squash on landing (jump-cancellable)
- Dash snaps directly to idle/run on ground (no transition anim, matches original MMX)
- 6 shoot animation overlays (idle, run, jump, fall, dash, wall_slide)
- Buster projectile from `assets/effects.png` (8x6 shot, 3-frame fade on wall hit)
- Projectile spawn from hand POI (`hx`/`hy` per animation frame)
- Wall slide: sprite flipped for wall-facing, shoots away from wall
- Dash-jump momentum: `isDashing` flag preserves 2x speed through jump/fall, clears on landing
- Charged buster: hold shoot to charge (2 levels), release for bigger animated projectile
- 8 charge particles orbit player while charging, character flashes white

**Enemies:**
- Tank Mechaniloid: patrol/turn/chase/attack/dying AI, 8 HP, fires projectiles
- Sprites from `assets/sigma_viral.png`, death explosion from `assets/effects.png`
- Full collision system: player shots hit enemies, enemy shots/body hit player

**Stage:**
- Highway stage from MMX-Deathmatch PNG assets (parallax + backwall + background layers)
- Collision rasterized from map.json polygon data onto 16x16 tile grid
- Spawn points loaded from map.json instances

**Engine:**
- Fixed 60fps game loop, keyboard input with pressed/held/released edge detection
- Tile-based AABB collision, camera viewport scrolling (256x224)
- Asset loader for images + JSON, no ROM dependency

### Plan Items

---

### 1. Finish Player Sprites (DONE)

**Completed:**
- ~~`land`~~ — Landing squash animation wired into state machine (jump-cancellable)
- ~~`warp_in`~~ — Level start teleport beam plays on spawn
- ~~`die`~~ — Death animation on 0 HP
- `crouch` — Crouching (1 frame, data exists, not wired — future if we add crouch mechanic)

**Note:** `dash_end` was initially added but removed after research showed original MMX has no dash-end transition — X snaps directly to idle/run.

---

### 2. Other Character Sprites

The MMX Deathmatch project contains spritesheets for many characters. Available at `MMX-Online-Deathmatch/LevelEditor/assets/spritesheets/`:

#### Priority characters:
| Character | Spritesheet | JSON Folder | Notes |
|-----------|-------------|-------------|-------|
| **Zero** | `ZeroDefault.png` | `sprites/zero/` | Second protagonist, sword-based |
| **Vile** | `VileDefault.png` | `sprites/vile/` | Enemy/boss character |
| **Sigma** | `SigmaDefault.png` | `sprites/sigma/` | Final boss |

#### Additional characters (lower priority):
- `AxlDefault.png` — Axl (X7/X8 character)
- 26+ Maverick boss spritesheets (`CrushCrawfish.png`, `StormEagle.png`, etc.)
- Each has corresponding JSON animation definitions

#### Implementation plan:
1. Copy needed spritesheets to `assets/`
2. Run `build_sprite_module.py` (or a variant) to generate sprite-data modules for each character
3. Create entity classes extending `Entity` with character-specific state machines
4. Enemies can use simpler AI state machines (patrol, chase, attack patterns)

---

### 3. Shooting & Projectile System (DONE)

All shooting features are implemented:
- Buster shot sprites from `effects.png` (8x6 sprite, direction-aware rendering)
- 3-frame fade/hit animation on wall collision
- Hand POI-based spawn position (`hx`/`hy` per animation frame)
- Max 3 shots, 8-frame cooldown
- 6 shoot animation overlays (idle, run, jump, fall, dash, wall_slide)

---

### 4. Dash-Jump Momentum (DONE)

- `isDashing` boolean flag preserves dash speed (2x multiplier) through jump/fall states
- Set on dash entry, persists through jump-cancel and air states
- Cleared on landing (land state), wall slide, hurt, or dash expiring on ground
- Matches MMX-Online-Deathmatch behavior: speed recomputed per frame (not inertia), releasing direction = stop

---

### 5. Charged Buster Shot (DONE)

Hold shoot to charge, release for bigger projectile:
- **Charge Level 1** (0.75s / 45 frames): buster2 projectile, damage 2, speed 6.0
- **Charge Level 2** (1.75s / 105 frames): buster3 projectile, damage 3, speed 7.0
- Normal lemon fires on press, charge builds while holding, charged shot fires on release
- 8 charge particles orbit player at 24px radius, converging toward center
- Character flashes white while charging (lighter composite at 40% alpha)
- Animated projectile sprites with startup → loop → fade phases
- Charge cleared on hurt/die

Sprite sources (all from effects.png):
- buster2: 8 frames (5 startup, 3 loop), buster3: 5 frames (2 startup, 3 loop)
- charge_part_1 (level 1): 2x2 → 1x1 pixels, charge_part_2 (level 2): 4x4 → 1x1 pixels

---

### 6. Enemy Characters (DONE — Tank Mechaniloid)

First enemy implemented: **Tank Mechaniloid** from `sigma_viral.png`.

**AI State Machine (5 states):**
- `patrol` — Walk left/right within 150px of spawn, turn at ledges/walls
- `turn` — Play 1-frame turn animation (10 frames), then flip direction
- `chase` — Move toward player when spotted within 130px sight range
- `attack` — Stop and fire projectile when player is within 125px horizontal, 30px vertical
- `dying` — Play 8-frame explosion animation from effects.png, then remove

**Combat:**
- 8 HP, takes damage from player buster shots (normal and charged)
- Fires 8x7 pixel projectile (damage 2, speed 3.0, 30-frame lifetime)
- Contact damage: 3 damage on body touch (60-frame cooldown)
- Projectile spawn from POI offset (20px forward, 15px up from feet)

**Collision System (in gameplay.js):**
- Player shots vs enemies: AABB overlap check, shot destroyed on hit
- Charged shots use larger hitboxes (20x16 for level 1, 32x28 for level 2)
- Enemy shots vs player: triggers `player.takeDamage()` with knockback direction
- Enemy body vs player: contact damage with cooldown

**Sprites:** 4 animations (walk: 2 frames, turn: 1 frame, shoot: 2 frames, proj: 1 frame), all from `sigma_viral.png` row y=991-1023. Death explosion: 8 frames from `effects.png`.

---

### Implementation Priority

1. ~~**Shooting overlay animations**~~ — DONE (6 shoot variants)
2. ~~**Projectile spawn from POI**~~ — DONE (hand position per frame)
3. ~~**Projectile sprites**~~ — DONE (lemon + fade on wall hit)
4. ~~**ROM removal + stage assets**~~ — DONE (highway stage PNG backgrounds + polygon collision)
5. ~~**Player animation states**~~ — DONE (warp_in, land, die)
6. ~~**Dash-jump momentum**~~ — DONE (isDashing flag, 2x speed through air)
7. ~~**Charged buster shot**~~ — DONE (2 charge levels, particles, flash, animated projectiles)
8. ~~**Enemy characters**~~ — DONE (Tank Mechaniloid: patrol, chase, shoot, die)
9. **More enemy types** — Hopper (jump + melee), Bird (flying) **<-- NEXT**
10. **Boss fights** — Multi-phase boss AI
11. **Additional stages** — More MMX-Deathmatch stage assets
12. **Health pickups / game over** — Item drops, respawn system

---

## Project Structure (Current)

```
mega-human/
├── index.html                    — Main game page (256×224 canvas, 3× scale)
├── PLAN.md                       — This file
├── assets/
│   ├── XDefault.png              — Player spritesheet (from MMX Deathmatch)
│   ├── effects.png               — Projectile/VFX spritesheet (buster shots, charge particles, explosions)
│   ├── sigma_viral.png           — Tank Mechaniloid spritesheet (enemy sprites + projectile)
│   ├── highway_background.png    — Highway stage background layer
│   ├── highway_backwall.png      — Highway stage backwall layer
│   ├── highway_parallax.png      — Highway stage parallax layer (0.5x scroll)
│   └── highway_map.json          — Highway stage collision polygons + spawn points
├── src/
│   ├── engine/
│   │   ├── game.js               — Fixed 60fps game loop
│   │   ├── input.js              — Keyboard input (pressed/held/released)
│   │   ├── camera.js             — Viewport scrolling (256×224)
│   │   └── collision.js          — Tile-based AABB collision (isSolid, resolveH/V, checkWall)
│   ├── entities/
│   │   ├── entity.js             — Base entity class + AABB overlap
│   │   ├── player.js             — Player: 10-state machine, shooting, charge, dash-jump
│   │   ├── sprite-data.js        — Player animation frames (19 anims) + projectile sprite data
│   │   └── tank-enemy.js         — Tank Mechaniloid: 5-state AI, patrol/shoot enemy
│   ├── states/
│   │   └── gameplay.js           — Gameplay state (PNG backgrounds, player, camera, HUD)
│   ├── levels/
│   │   └── level.js              — Level from map.json (polygon→tile-grid rasterizer)
│   └── assets/
│       └── asset-loader.js       — Image + JSON loading/caching
├── analysis/
│   └── build_sprite_module.py    — Generates sprite-data.js from MMX Deathmatch JSONs
├── tools/
│   ├── tile-viewer.html          — ROM tile browser (legacy)
│   ├── sprite-assembler.html     — Manual sprite assembly tool (legacy)
│   └── sprite-finder.html        — Tile search tool (legacy)
└── MMX-Online-Deathmatch/        — Reference project (NOT used at runtime)
```

---

## Key Technical Notes

**Grounded detection quirk:** `resolveVertical()` in `collision.js` only returns `grounded: true` when `dy > 0` (moving downward). If any ground state sets `this.vy = 0`, `dy` becomes 0, and `grounded` returns `false` — causing rapid state oscillation (e.g. idle → fall → land → idle) with visible shaking. **All ground states MUST apply gravity** (`this.vy += P.GRAVITY`) and let the collision system resolve the position. This was the root cause of multiple bugs during land/dash implementation.

**Sprite alignment:** All player sprites are aligned bottom-center (feet anchor). The rendering offset `ox`/`oy` is per-frame. Flip axis is always at `feetX` (character center) for left-facing sprites. Wall slide sprites face toward the wall, so flip is inverted.

**MMX dash behavior:** Original MMX has NO dash-end transition animation. X snaps directly from dash to idle/run. Early attempt to add a `dash_end` state was removed after verifying this against the MMX-Online-Deathmatch source (CharState.cs).

**Charge composite rendering:** Canvas2D `globalCompositeOperation = 'lighter'` with `globalAlpha = 0.4` creates a convincing "charge flash" without shaders. The sprite is drawn twice — once normal, once with lighter blend mode.

---

## Appendix: ROM Reverse Engineering Findings

_Preserved from Plan 1.0 for reference. This data is accurate but the tile-based rendering approach was abandoned in favor of PNG spritesheets._

### Hardware: CX4 Coprocessor

The cartridge PCB is **SHVC-2DC0N-01** with a **Capcom CX4** coprocessor (Hitachi HG51B169 DSP, 20 MHz). ROM header chipset byte = `$F3` (CX4 confirmed). The CX4 is mapped at `$6000-$7FFF` in banks `$00-$3F`.

The CX4 handles:
- Player sprite DMA (tile streaming from ROM to VRAM)
- OAM table construction (assembling sprite objects from parts)
- Wireframe 3D effects (intro sequences)
- Trigonometric calculations for scaling/rotation

### Key ROM Addresses

| Address | ROM Offset | Purpose |
|---------|-----------|---------|
| `$00:80BE` | `0x0000BE` | CX4 initialization |
| `$00:A8A6` | `0x00A8A6` | Player spawn: entity type `$9D` |
| `$08:85DD` | `0x0405DD` | Entity sprite handler pointer table |
| `$08:C690` | `0x044690` | Animation controller init |
| `$08:C673` | `0x044673` | Animation tick |
| `$08:CA5C` | `0x044A5C` | CX4 sprite DMA routine |
| `$2F:D4D6` | `0x17D4D6` | Player animation base (11 anims, defs 0-18) |
| `$05:9609` | `0x029609` | Player sprite DMA transfer table (112 entries) |

### Animation System

3-byte frame format: `[duration] [flags] [sprite_def_index]`
- 11 animations, 19 sprite defs
- DMA remaps tiles 0-31 per frame, legs (64+) loaded at init
- Palette 14 at ROM `0x02BFC0`

### DMA Transfer Entry Format (6 bytes)

```
[0] Tile count (×16 = byte count)
[1] Source addr low
[2] Source addr high
[3] Source bank ($2D = player tilesheet at 0x168000)
[4] VRAM dest low
[5] VRAM dest high (bit 15 = last entry flag)
```

### 4-Block OAM Layout

```
head:   VRAM tiles (0,1,16,17)  at pixel (16, 2)
ubodyL: VRAM tiles (4,5,20,21)  at pixel (12, 16)
ubodyR: VRAM tiles (6,7,22,23)  at pixel (20, 16)
legs:   VRAM tiles (64,65,80,81) at pixel (16, 32)
```
